title: 前端跨域
date: 2017-05-07
tags: 经验

---

这里所谓的跨域问题，其实就是javascript为了在不同的域之间进行数据通信，由于浏览器具有同源策略，对于不同域(协议，域名，端口不同)之间的数据通信有一定的安全限制。

## 解决跨域问题：
**1.服务端加上响应头**
```
header("Access-Control-Allow-Origin: *");
header("Access-COntrol-Allow-Methods: GET,POST");
```

**2.jsonP(json with padding)**
jsonP跨域主要利用script src引入的js文件是没有受到同源策略的限制的
```
<script type="text/javascript" src="http://domain2.com/getjson?jsonp=parseResponse"></script>
```
jQuery中的实现：
```
$.ajax({
    type: 'GET',
    url: '...',
    dataType: 'jsonp',
    jsonpCallback: 'cb', //回调函数名
    success: function(mes) {
        //...
    }
})

$.getJSON(url("...&jsoncallback=?"),data,function(mes){
    //...
})
//后台将？随机成一个方法名，进行返回
```

**3.中间代理**
网上看到最多的中间代理就是iframe了，但是它的兼容性还是需要考虑的（在iphone上体验过iframe标签无效）

### document.domain
 www.a.com/a.html:
```
document.domain = 'a.com';
var ifr = document.createElement('iframe'); //创建交互iframe
ifr.src = 'http://www.script.a.com/b.html';
ifr.style.display = 'none';
document.body.appendChild(ifr);
ifr.onload = function() {
    var doc = ifr.contentDocument || ifr.contentWIndow.document; //获取交互iframe的document进行操作
    ifr.onload = null;
}
```
www.script.a.com/b.html:
```
document.domain = 'a.html'; //相同主域
```

### location.hash
a.com/a.html:
```
//创建交互iframe
var ifr = document.createElement('iframe');
ifr.style.display = 'none';
ifr.src = 'http://b.com/b.html#hash'; //交互iframe地址，可带hash传入
document.body.appendChild(ifr);

//轮询自身hash是否改变，以便获取响应
setInterval(function(){
    var data = location.hash ? location.hash.substring(1) : ''; //获取hash，substring(1)去#
},2000)
```

b.com/b.html
```
var data = location.hash;   //获取传入的数据(带#)
try {
    parent.location.hash = '...' //给父窗口响应数据
} catch (e) {
    // ie，chrome具有安全机制不同域无法修改parent的hash值
    //创建中间iframe代理，域在a.com下
    var ifr = document.createElement('iframe');
    ifr.style.display = 'none';
    ifr.src = 'http://a.com/c.html#hash'; //将响应返回数据写入代理
}
```

a.com/c.html:
```
parent.parent.loaction.hash = location.hash.substring(1) //修改最上层窗口hash，将返回数据写入
```

### window.name
a.com/a.html:
```
var ifr = document.createElement('iframe');
ifr.src = 'http://b.com/b.html';
ifr.style.display = 'none';
document.body.appendChild(ifr);
//触发或轮询获取ifr.contentWindow.name
```
b.com/b.html:
```
window.name = 'data';
```

### H5 postMessage()
a.com/index.html:
```
//<iframe src="b.com/index.html"></iframe>
var ifr = window.frame[0].postMessage(message,originTarget)
//originTarget目标窗口(协议+主机+端口号)，可写*表示所有窗口，或者b.com+(url可省略，写了也无效)
```
b.com/index.html:
```
window.addEventListener('message',function(e) {
    //e.origin为消息来源，如http://a.com
    //e.data为传递的消息
    //e.source发送消息的窗口对象
})
```

**4.websocket(全双工，双向通信)**
同源策略对websocket协议不适用

[脚本之家一些ajax跨域的汇总][1]


  [1]: http://www.jb51.net/Special/894.htm
